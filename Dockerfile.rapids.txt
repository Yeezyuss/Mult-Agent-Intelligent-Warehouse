# NVIDIA RAPIDS Demand Forecasting Agent
# Docker setup for GPU-accelerated forecasting with cuML

FROM nvcr.io/nvidia/rapidsai/rapidsai:24.02-cuda12.0-runtime-ubuntu22.04-py3.10

# Set working directory
WORKDIR /app

# Install additional dependencies
RUN pip install asyncpg psycopg2-binary xgboost

# Copy application files
COPY scripts/forecasting/rapids_gpu_forecasting.py /app/rapids_forecasting_agent.py
COPY requirements.txt /app/

# Install Python dependencies
RUN pip install -r requirements.txt

# Set environment variables
ENV CUDA_VISIBLE_DEVICES=0
ENV NVIDIA_VISIBLE_DEVICES=all
ENV NVIDIA_DRIVER_CAPABILITIES=compute,utility

# Create data directory
RUN mkdir -p /app/data

# Create non-root user for security
# Security: Run container as non-privileged user to prevent privilege escalation
RUN groupadd -r rapidsuser && \
    useradd -r -g rapidsuser -u 1000 rapidsuser && \
    chown -R rapidsuser:rapidsuser /app

# Switch to non-root user
USER rapidsuser

# Expose port for API (if needed)
EXPOSE 8002

# Default command
CMD ["python", "rapids_forecasting_agent.py"]
